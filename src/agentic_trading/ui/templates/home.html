{% extends "base.html" %}
{% from "partials/section_header.html" import section_header %}
{% set active_tab = "home" %}
{% block title %}Mission Control{% endblock %}

{% block content %}

<!-- Critical Banner (only shows when degraded) -->
<div id="banner-container"
     hx-get="/partials/home/banner"
     hx-trigger="every 5s"
     hx-swap="innerHTML">
  {% include "partials/banner.html" %}
</div>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 1: PORTFOLIO
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-portfolio">
  {{ section_header("PORTFOLIO", live=True, id="section-portfolio", tooltip="Account equity and daily performance score. Agents grade edge, execution, risk, and system health each day. Use period tabs to compare PnL.") }}
  <div class="section-body">
    <div class="grid-2">
      <!-- Daily Effectiveness Score -->
      <div class="card"
           id="scorecard-container"
           hx-get="/partials/home/scorecard"
           hx-trigger="every 10s"
           hx-swap="innerHTML">
        {% include "partials/scorecard_card.html" %}
      </div>

      <!-- Portfolio Summary -->
      <div class="card"
           id="portfolio-container"
           hx-get="/partials/home/portfolio"
           hx-trigger="every 5s"
           hx-swap="innerHTML">
        {% include "partials/portfolio_card.html" %}
      </div>
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 2: EQUITY CURVE
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-equity">
  {{ section_header("EQUITY CURVE", live=True, id="section-equity", tooltip="Total account equity plotted over time. Hover any point to see the exact balance. Updates as fills are processed by the execution engine.") }}
  <div class="section-body">
    <div class="card" style="padding:6px 8px;">
      <div style="display:flex;justify-content:flex-end;gap:4px;margin-bottom:4px;">
        <button class="filter-btn eq-range-btn" data-range="4h">4H</button>
        <button class="filter-btn eq-range-btn active" data-range="8h">8H</button>
        <button class="filter-btn eq-range-btn" data-range="1d">1D</button>
        <button class="filter-btn eq-range-btn" data-range="1w">1W</button>
      </div>
      <div style="position:relative; width:100%; height:160px;">
        <canvas id="equityChart"></canvas>
      </div>
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 3: RISK PnL & POSTURE (NEW)
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-risk-pnl">
  {{ section_header("RISK PnL & POSTURE", live=True, id="section-risk-pnl", tooltip="PnL breakdown by strategy with current risk posture. Shows leverage, Value at Risk, drawdown, and daily loss budget usage.") }}
  <div class="section-body">
    <div class="card"
         id="risk-pnl-container"
         hx-get="/partials/risk-pnl/summary"
         hx-trigger="every 15s"
         hx-swap="innerHTML">
      {% if risk_pnl is defined %}
        {% include "partials/risk_pnl_card.html" %}
      {% else %}
        <div class="card-label">RISK PnL & POSTURE</div>
        <div class="empty-state"><div class="empty-message">Loading...</div></div>
      {% endif %}
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 4: POSITIONS
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-positions">
  {{ section_header("POSITIONS", live=True, count=positions|length if positions is defined else 0, id="section-positions", tooltip="All open positions on the exchange with live mark-to-market PnL. Click CLOSE to submit a market exit order. Synced every 5 seconds.") }}
  <div class="section-body">
    <div class="card"
         id="positions-container"
         hx-get="/partials/home/positions"
         hx-trigger="every 5s"
         hx-swap="innerHTML">
      {% include "partials/positions_card.html" %}
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 5: STRATEGIES
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-strategies">
  {{ section_header("STRATEGIES", count=strategies|length if strategies is defined else 0, id="section-strategies", tooltip="Registered strategies with lifecycle stage, quality grade, and track record. Click PROMOTE to request advancement to the next stage.") }}
  <div class="section-body">
    <div class="card"
         id="strategies-list"
         hx-get="/partials/strategies/list"
         hx-trigger="every 30s"
         hx-swap="innerHTML">
      {% include "partials/strategies_list.html" %}
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 6: ACTIVITY
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-activity">
  {{ section_header("ACTIVITY", live=True, id="section-activity", tooltip="Chronological feed of signals, fills, governance decisions, and incidents. Use filter tabs to isolate event types.") }}
  <div class="section-body">
    <div class="card">
      <!-- Filters -->
      <div class="timeline-filters">
        <button class="filter-btn active"
                hx-get="/partials/activity/timeline?type=all"
                hx-target="#timeline-content"
                hx-swap="innerHTML">ALL</button>
        <button class="filter-btn"
                hx-get="/partials/activity/timeline?type=trades"
                hx-target="#timeline-content"
                hx-swap="innerHTML">TRADES</button>
        <button class="filter-btn"
                hx-get="/partials/activity/timeline?type=signals"
                hx-target="#timeline-content"
                hx-swap="innerHTML">SIGNALS</button>
        <button class="filter-btn"
                hx-get="/partials/activity/timeline?type=governance"
                hx-target="#timeline-content"
                hx-swap="innerHTML">POLICY</button>
        <button class="filter-btn"
                hx-get="/partials/activity/timeline?type=approvals"
                hx-target="#timeline-content"
                hx-swap="innerHTML">APPROVALS</button>
        <button class="filter-btn"
                hx-get="/partials/activity/timeline?type=incidents"
                hx-target="#timeline-content"
                hx-swap="innerHTML">INCIDENTS</button>
      </div>

      <!-- Timeline content (HTMX polling) -->
      <div id="timeline-content"
           hx-get="/partials/activity/timeline?type=all"
           hx-trigger="every 10s"
           hx-swap="innerHTML">
        {% if events is defined %}
          {% include "partials/activity_timeline.html" %}
        {% else %}
          <div class="empty-state"><div class="empty-message">Loading timeline...</div></div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 7: MODEL SCORECARD & DRIFT (NEW)
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-model-scorecard">
  {{ section_header("MODEL SCORECARD & DRIFT", id="section-model-scorecard", tooltip="Model lifecycle tracking and drift detection. Compares live metrics against baselines to catch strategy degradation early.") }}
  <div class="section-body">
    <div class="grid-2">
      <!-- Model Registry -->
      <div class="card"
           id="model-registry-container"
           hx-get="/partials/model-scorecard/models"
           hx-trigger="every 30s"
           hx-swap="innerHTML">
        {% if models is defined %}
          {% include "partials/model_registry_card.html" %}
        {% else %}
          <div class="card-label">MODEL REGISTRY</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>

      <!-- Drift Indicators -->
      <div class="card"
           id="drift-indicators-container"
           hx-get="/partials/model-scorecard/drift"
           hx-trigger="every 15s"
           hx-swap="innerHTML">
        {% if drift_data is defined %}
          {% include "partials/drift_indicators_card.html" %}
        {% else %}
          <div class="card-label">DRIFT INDICATORS</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>
    </div>

    <div class="grid-2" style="margin-top:var(--grid-gap);">
      <!-- Effectiveness Scorecard -->
      <div class="card"
           id="effectiveness-container"
           hx-get="/partials/model-scorecard/effectiveness"
           hx-trigger="every 10s"
           hx-swap="innerHTML">
        {% if effectiveness is defined %}
          {% include "partials/effectiveness_card.html" %}
        {% else %}
          <div class="card-label">EFFECTIVENESS</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>

      <!-- Execution Quality -->
      <div class="card"
           id="exec-quality-container"
           hx-get="/partials/model-scorecard/exec-quality"
           hx-trigger="every 10s"
           hx-swap="innerHTML">
        {% if exec_quality is defined %}
          {% include "partials/exec_quality_card.html" %}
        {% else %}
          <div class="card-label">EXECUTION QUALITY</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 8: ACTION QUEUE & ALERTS (NEW)
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-action-queue">
  {{ section_header("ACTION QUEUE & ALERTS", live=True, id="section-action-queue", tooltip="Trade requests awaiting review, active incidents, and recent governance decisions. Approve, deny, or resolve items here.") }}
  <div class="section-body">
    <div class="grid-2">
      <!-- Pending Approvals (full cards) -->
      <div class="card"
           id="action-approvals-container"
           hx-get="/partials/action-queue/approvals"
           hx-trigger="every 5s"
           hx-swap="innerHTML">
        {% if approvals is defined %}
          {% include "partials/action_approvals_card.html" %}
        {% else %}
          <div class="card-label">PENDING APPROVALS</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>

      <!-- Active Incidents -->
      <div class="card"
           id="action-incidents-container"
           hx-get="/partials/action-queue/incidents"
           hx-trigger="every 5s"
           hx-swap="innerHTML">
        {% if active_incidents is defined %}
          {% include "partials/action_incidents_card.html" %}
        {% else %}
          <div class="card-label">ACTIVE INCIDENTS</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>
    </div>

    <div class="grid-2" style="margin-top:var(--grid-gap);">
      <!-- Recent Decisions -->
      <div class="card"
           id="action-decisions-container"
           hx-get="/partials/action-queue/decisions"
           hx-trigger="every 10s"
           hx-swap="innerHTML">
        {% if recent_decisions is defined %}
          {% include "partials/action_decisions_card.html" %}
        {% else %}
          <div class="card-label">RECENT DECISIONS</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>

      <!-- Alert Feed -->
      <div class="card"
           id="action-alerts-container"
           hx-get="/partials/action-queue/alerts"
           hx-trigger="every 10s"
           hx-swap="innerHTML">
        {% if alerts is defined %}
          {% include "partials/action_alerts_card.html" %}
        {% else %}
          <div class="card-label">ALERTS</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 9: PRE-TRADE CONTROLS (NEW)
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-pre-trade">
  {{ section_header("PRE-TRADE CONTROLS", live=True, id="section-pre-trade", tooltip="Safety checks that run before every order submission. Pass rates and throttle meters show health at the pre-trade gate.") }}
  <div class="section-body">
    <div class="grid-2">
      <!-- Check Status Grid -->
      <div class="card"
           id="pre-trade-checks-container"
           hx-get="/partials/pre-trade/checks"
           hx-trigger="every 10s"
           hx-swap="innerHTML">
        {% if check_stats is defined %}
          {% include "partials/pre_trade_checks_card.html" %}
        {% else %}
          <div class="card-label">PRE-TRADE CHECKS</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>

      <!-- Message Throttles -->
      <div class="card"
           id="pre-trade-throttles-container"
           hx-get="/partials/pre-trade/throttles"
           hx-trigger="every 5s"
           hx-swap="innerHTML">
        {% if throttle_data is defined %}
          {% include "partials/pre_trade_throttles_card.html" %}
        {% else %}
          <div class="card-label">MESSAGE THROTTLES</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 10: RISK & CONTROLS (circuit breakers + governance)
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-risk">
  {{ section_header("RISK & CONTROLS", id="section-risk", tooltip="Portfolio risk limits, circuit breakers, and governance policy status. Breakers trip automatically when thresholds are exceeded.") }}
  <div class="section-body">
    <div class="grid-2">
      <!-- Risk Gauges -->
      <div class="card"
           id="risk-gauges"
           hx-get="/partials/risk/gauges"
           hx-trigger="every 15s"
           hx-swap="innerHTML">
        {% if risk_gauges is defined %}
          {% include "partials/risk_gauges.html" %}
        {% else %}
          <div class="card-label">RISK LIMITS</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>

      <!-- Circuit Breakers -->
      <div class="card"
           id="circuit-breakers-card"
           hx-get="/partials/risk/circuit-breakers"
           hx-trigger="every 10s"
           hx-swap="innerHTML">
        {% if circuit_breakers is defined %}
          {% include "partials/circuit_breakers_card.html" %}
        {% else %}
          <div class="card-label">CIRCUIT BREAKERS</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>
    </div>

    <!-- Governance Status (inline) -->
    {% if risk_controls is defined %}
    <div class="card" style="margin-top:3px;">
      <div class="card-label">GOVERNANCE <span class="tooltip-wrap info-icon">&#9432;<span class="tooltip-text">Policy engine and approval workflow status. Shadow mode logs violations without blocking trades. Shows active rule count.</span></span></div>
      <div style="margin-top:6px; display:grid; grid-template-columns:1fr 1fr; gap:8px; font-size:11px;">
        <div>
          <span style="color:var(--text-muted);">POLICY ENGINE</span>
          {% if risk_controls.policy_engine_enabled %}
            <span class="badge badge-positive" style="margin-left:4px;font-size:9px;">ACTIVE</span>
            <span style="color:var(--text-muted);margin-left:4px;">{{ risk_controls.policy_rules_count }} rules</span>
          {% else %}
            <span class="badge badge-warning" style="margin-left:4px;font-size:9px;">OFF</span>
          {% endif %}
        </div>
        <div>
          <span style="color:var(--text-muted);">APPROVAL WORKFLOW</span>
          {% if risk_controls.approval_workflow %}
            <span class="badge badge-positive" style="margin-left:4px;font-size:9px;">ON</span>
            {% if risk_controls.auto_approve_l1 %}
              <span style="color:var(--text-muted);margin-left:4px;">auto L1</span>
            {% endif %}
          {% else %}
            <span class="badge badge-warning" style="margin-left:4px;font-size:9px;">OFF</span>
          {% endif %}
        </div>
        <div>
          <span style="color:var(--text-muted);">SHADOW MODE</span>
          {% if risk_controls.shadow_mode %}
            <span class="badge badge-warning" style="margin-left:4px;font-size:9px;">ON</span>
          {% else %}
            <span style="color:var(--text-muted);margin-left:4px;">Off (enforcing)</span>
          {% endif %}
        </div>
        <div>
          <span style="color:var(--text-muted);">PENDING</span>
          {% if risk_controls.pending_approvals > 0 %}
            <span class="count-badge" style="margin-left:4px;">{{ risk_controls.pending_approvals }}</span>
          {% else %}
            <span style="color:var(--text-muted);margin-left:4px;">None</span>
          {% endif %}
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 11: MICRO-EDGE & SURVEILLANCE (NEW)
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-micro-edge">
  {{ section_header("MICRO-EDGE & SURVEILLANCE", id="section-micro-edge", tooltip="Risk-adjusted return analysis and compliance monitoring. R-multiples measure trade quality. Surveillance tracks open cases.") }}
  <div class="section-body">
    <div class="grid-2">
      <!-- R-Multiple Distribution -->
      <div class="card"
           id="r-distribution-container"
           hx-get="/partials/micro-edge/distribution"
           hx-trigger="every 30s"
           hx-swap="innerHTML">
        {% if r_stats is defined %}
          {% include "partials/r_distribution_card.html" %}
        {% else %}
          <div class="card-label">R-MULTIPLE DISTRIBUTION</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>

      <!-- Edge Analysis -->
      <div class="card"
           id="edge-analysis-container"
           hx-get="/partials/micro-edge/edge-analysis"
           hx-trigger="every 30s"
           hx-swap="innerHTML">
        {% if edge is defined %}
          {% include "partials/edge_analysis_card.html" %}
        {% else %}
          <div class="card-label">EDGE ANALYSIS</div>
          <div class="empty-state"><div class="empty-message">Loading...</div></div>
        {% endif %}
      </div>
    </div>

    <!-- Surveillance -->
    <div class="card" style="margin-top:var(--grid-gap);"
         id="surveillance-container"
         hx-get="/partials/micro-edge/surveillance"
         hx-trigger="every 10s"
         hx-swap="innerHTML">
      {% if surveillance is defined %}
        {% include "partials/surveillance_card.html" %}
      {% else %}
        <div class="card-label">SURVEILLANCE</div>
        <div class="empty-state"><div class="empty-message">Loading...</div></div>
      {% endif %}
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     SECTION 12: SYSTEM (agent health only)
     ═══════════════════════════════════════════════════════════════ -->
<section id="section-system">
  {{ section_header("SYSTEM", id="section-system", tooltip="Agent health and system status. Shows running agents, error counts, and last data feed timestamp.") }}
  <div class="section-body">
    <div class="card"
         id="system-container"
         hx-get="/partials/home/system"
         hx-trigger="every 10s"
         hx-swap="innerHTML">
      {% include "partials/system_card.html" %}
    </div>
  </div>
</section>

<!-- ═══════════════════════════════════════════════════════════════
     MODALS
     ═══════════════════════════════════════════════════════════════ -->

<!-- Kill Switch Confirmation Modal -->
<div class="modal-overlay hidden" id="kill-switch-modal" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="modal-title" id="ks-modal-title">CONFIRM ACTION</div>
    <div class="modal-body" id="ks-modal-body"></div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeKillSwitchModal()">CANCEL</button>
      <button class="btn" id="ks-modal-confirm" onclick="submitKillSwitch()">CONFIRM</button>
    </div>
  </div>
</div>

<!-- Strategy Promotion Modal -->
<div class="modal-overlay hidden" id="promote-modal" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="modal-title">PROMOTE STRATEGY?</div>
    <div class="modal-body" id="promote-modal-body">
      This will request promotion for this strategy to the next stage.
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closePromoteModal()">CANCEL</button>
      <button class="btn btn-primary" id="promote-modal-confirm" onclick="submitPromotion()">CONFIRM PROMOTION</button>
    </div>
  </div>
</div>

<!-- Close Position Modal -->
<div class="modal-overlay hidden" id="close-position-modal" role="dialog" aria-modal="true">
  <div class="modal-box">
    <div class="modal-title">CLOSE POSITION?</div>
    <div class="modal-body" id="close-pos-modal-body">
      This will submit a market order to close this position.
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closeClosePositionModal()">CANCEL</button>
      <button class="btn" id="close-pos-modal-confirm" style="background:var(--color-negative);"
              onclick="submitClosePosition()">CLOSE POSITION</button>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  /* ═══════════════════════════════════════════════
     KILL SWITCH
     ═══════════════════════════════════════════════ */
  var _ksAction = null;

  function showKillSwitchModal(action) {
    _ksAction = action;
    var modal = document.getElementById('kill-switch-modal');
    var title = document.getElementById('ks-modal-title');
    var body = document.getElementById('ks-modal-body');
    var confirm = document.getElementById('ks-modal-confirm');

    if (action === 'activate') {
      title.textContent = 'ACTIVATE EMERGENCY STOP?';
      body.innerHTML = '<strong style="color:var(--color-negative);">THIS WILL IMMEDIATELY HALT ALL NEW ORDERS.</strong><br><br>Existing open positions will remain. Only activate in a genuine emergency. This action is logged in the audit trail.';
      confirm.className = 'btn';
      confirm.style.background = 'var(--color-negative)';
      confirm.textContent = 'YES, ACTIVATE';
    } else {
      title.textContent = 'RESUME TRADING?';
      body.innerHTML = 'This will deactivate the emergency stop and allow new orders to be placed again. Confirm only when the situation is resolved.';
      confirm.className = 'btn btn-primary';
      confirm.style.background = '';
      confirm.textContent = 'YES, RESUME';
    }
    modal.classList.remove('hidden');
  }

  function closeKillSwitchModal() {
    document.getElementById('kill-switch-modal').classList.add('hidden');
    _ksAction = null;
  }

  function submitKillSwitch() {
    if (!_ksAction) return;
    var endpoint = _ksAction === 'activate'
      ? '/actions/kill-switch/activate'
      : '/actions/kill-switch/deactivate';

    fetch(endpoint, { method: 'POST' })
      .then(function(r) { return r.text(); })
      .then(function(html) {
        // Refresh the command bar to reflect new state
        htmx.ajax('GET', '/partials/command-bar', '#command-bar');
        closeKillSwitchModal();
      })
      .catch(function() { closeKillSwitchModal(); });
  }

  document.getElementById('kill-switch-modal').addEventListener('click', function(e) {
    if (e.target === this) closeKillSwitchModal();
  });

  /* ═══════════════════════════════════════════════
     STRATEGY PROMOTION
     ═══════════════════════════════════════════════ */
  var _pendingStrategyId = null;

  function confirmPromotion(strategyId, currentStage, score) {
    _pendingStrategyId = strategyId;
    document.getElementById('promote-modal-body').innerHTML =
      '<strong>' + strategyId.replace(/_/g, ' ').replace(/\b\w/g, function(l) { return l.toUpperCase(); }) +
      '</strong> is currently in <em>' + currentStage + '</em> with a quality score of <strong>' +
      score + '/100</strong>.<br><br>Request promotion to the next stage?';
    document.getElementById('promote-modal').classList.remove('hidden');
  }

  function closePromoteModal() {
    document.getElementById('promote-modal').classList.add('hidden');
    _pendingStrategyId = null;
  }

  function submitPromotion() {
    if (_pendingStrategyId) {
      var btn = document.getElementById('promote-submit-' + _pendingStrategyId);
      if (btn) btn.click();
      closePromoteModal();
    }
  }

  document.getElementById('promote-modal').addEventListener('click', function(e) {
    if (e.target === this) closePromoteModal();
  });

  /* ═══════════════════════════════════════════════
     CLOSE POSITION
     ═══════════════════════════════════════════════ */
  var _closePosSymbol = null;

  function showClosePositionModal(symbol) {
    _closePosSymbol = symbol;
    document.getElementById('close-pos-modal-body').innerHTML =
      'Submit a market order to close <strong>' + symbol + '</strong>?<br><br>This action cannot be undone.';
    document.getElementById('close-position-modal').classList.remove('hidden');
  }

  function closeClosePositionModal() {
    document.getElementById('close-position-modal').classList.add('hidden');
    _closePosSymbol = null;
  }

  function submitClosePosition() {
    if (!_closePosSymbol) return;
    fetch('/actions/close-position/' + encodeURIComponent(_closePosSymbol), { method: 'POST' })
      .then(function() { closeClosePositionModal(); htmx.ajax('GET', '/partials/home/positions', '#positions-container'); })
      .catch(function() { closeClosePositionModal(); });
  }

  document.getElementById('close-position-modal').addEventListener('click', function(e) {
    if (e.target === this) closeClosePositionModal();
  });

  /* ═══════════════════════════════════════════════
     ACTIVITY FILTER BUTTONS
     ═══════════════════════════════════════════════ */
  document.addEventListener('click', function(e) {
    if (e.target.matches('.filter-btn')) {
      document.querySelectorAll('.filter-btn').forEach(function(b) { b.classList.remove('active'); });
      e.target.classList.add('active');
    }
  });

  /* ═══════════════════════════════════════════════
     EQUITY CHART (with time-range selector)
     ═══════════════════════════════════════════════ */
  var equityChart = null;

  function loadEquityCurve(range) {
    fetch('/api/equity-curve?range=' + range)
      .then(function(r) { return r.json(); })
      .then(function(data) {
        var canvas = document.getElementById('equityChart');
        var ctx = canvas.getContext('2d');
        var chartHeight = canvas.parentElement.clientHeight || 160;
        var gradient = ctx.createLinearGradient(0, 0, 0, chartHeight);
        gradient.addColorStop(0, 'rgba(0, 255, 136, 0.15)');
        gradient.addColorStop(1, 'rgba(0, 255, 136, 0.0)');

        if (equityChart) {
          equityChart.data.labels = data.map(function(d) { return d.time; });
          equityChart.data.datasets[0].data = data.map(function(d) { return d.equity; });
          equityChart.data.datasets[0].backgroundColor = gradient;
          equityChart.update();
          return;
        }

        equityChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: data.map(function(d) { return d.time; }),
            datasets: [{
              data: data.map(function(d) { return d.equity; }),
              borderColor: '#00ff88',
              borderWidth: 1.5,
              backgroundColor: gradient,
              fill: true,
              tension: 0.3,
              pointRadius: 0,
              pointHoverRadius: 3,
              pointHoverBackgroundColor: '#00ff88',
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { intersect: false, mode: 'index' },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#111125',
                borderColor: 'rgba(0,255,136,0.3)',
                borderWidth: 1,
                titleColor: '#8b95a5',
                bodyColor: '#e0e0e0',
                bodyFont: { family: '"JetBrains Mono", monospace', weight: '600', size: 11 },
                padding: 8,
                cornerRadius: 3,
                callbacks: {
                  label: function(ctx) {
                    return '$' + ctx.parsed.y.toLocaleString(undefined, {
                      minimumFractionDigits: 2, maximumFractionDigits: 2
                    });
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255,255,255,0.04)' },
                ticks: { color: '#5a6577', font: { size: 9, family: '"JetBrains Mono", monospace' }, maxTicksLimit: 12 }
              },
              y: {
                grid: { color: 'rgba(255,255,255,0.04)' },
                ticks: {
                  color: '#5a6577',
                  font: { size: 9, family: '"JetBrains Mono", monospace' },
                  callback: function(v) { return '$' + (v/1000).toFixed(0) + 'k'; }
                }
              }
            }
          }
        });
      })
      .catch(function() { /* Equity API not available yet */ });
  }

  /* Initial load */
  loadEquityCurve('8h');

  /* Time range button handler */
  document.querySelectorAll('.eq-range-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.eq-range-btn').forEach(function(b) { b.classList.remove('active'); });
      btn.classList.add('active');
      loadEquityCurve(btn.dataset.range);
    });
  });

  /* ═══════════════════════════════════════════════
     R-MULTIPLE HISTOGRAM
     ═══════════════════════════════════════════════ */
  fetch('/api/r-distribution')
    .then(function(r) { return r.json(); })
    .then(function(data) {
      var el = document.getElementById('rDistChart');
      if (!el || !data.length) return;
      var ctx = el.getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: data.map(function(d) { return d.label; }),
          datasets: [{
            data: data.map(function(d) { return d.count; }),
            backgroundColor: data.map(function(d) { return d.color; }),
            borderWidth: 0,
            borderRadius: 2,
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: '#111125',
              borderColor: 'rgba(0,255,136,0.3)',
              borderWidth: 1,
              titleColor: '#8b95a5',
              bodyColor: '#e0e0e0',
              bodyFont: { family: '"JetBrains Mono", monospace', size: 11 },
              padding: 6,
              cornerRadius: 3,
              callbacks: {
                label: function(ctx) { return ctx.parsed.y + ' trades'; }
              }
            }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#5a6577', font: { size: 8, family: '"JetBrains Mono", monospace' } }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.04)' },
              ticks: { color: '#5a6577', font: { size: 9, family: '"JetBrains Mono", monospace' }, precision: 0 }
            }
          }
        }
      });
    })
    .catch(function() { /* R-distribution API not available yet */ });
</script>
{% endblock %}
