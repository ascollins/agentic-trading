<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{% block title %}Supervision{% endblock %} — Trading Ops</title>
  <link rel="stylesheet" href="/static/css/theme.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
  {% block head %}{% endblock %}
</head>
<body>
  <div class="app-shell">
    <!-- Command Bar -->
    <header class="command-bar"
            id="command-bar"
            hx-get="/partials/command-bar"
            hx-trigger="every 10s"
            hx-swap="innerHTML">
      {% if status_bar is defined %}
        {% include "partials/command_bar.html" %}
      {% else %}
        <span class="command-bar-logo">SUPERVISION</span>
        <div class="command-bar-sep"></div>
        <span class="command-bar-item">LOADING...</span>
      {% endif %}
    </header>

    <!-- Main content -->
    <main class="main-content">
      {% block content %}{% endblock %}
    </main>
  </div>

  <!-- Toast notification container -->
  <div id="toast-container" class="toast-container"></div>

  <!-- Global utilities -->
  <script>
    // --- Toast notification system ---
    function showToast(message, type) {
      type = type || 'success';
      var container = document.getElementById('toast-container');
      if (!container) return;
      var toast = document.createElement('div');
      toast.className = 'toast toast-' + type;
      var icon = type === 'success' ? '✓' : type === 'error' ? '✕' : '⚠';
      toast.innerHTML = '<span>' + icon + '</span> <span>' + message + '</span>';
      container.appendChild(toast);
      setTimeout(function () {
        toast.classList.add('fade-out');
        setTimeout(function () { toast.remove(); }, 400);
      }, 5000);
    }

    document.body.addEventListener('showToast', function (evt) {
      if (evt.detail && evt.detail.message) {
        showToast(evt.detail.message, evt.detail.type || 'success');
      }
    });

    // --- Global Escape key handler for modals ---
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') {
        var modals = document.querySelectorAll('.modal-overlay:not(.hidden)');
        if (modals.length > 0) {
          modals[modals.length - 1].classList.add('hidden');
          e.preventDefault();
        }
      }
    });

    // --- Clock updater ---
    (function updateClock() {
      var el = document.getElementById('command-bar-clock');
      if (el) {
        var now = new Date();
        el.textContent = now.toUTCString().replace('GMT', 'UTC');
      }
      setTimeout(updateClock, 1000);
    })();

    // --- Approval badge + tab title updater ---
    (function () {
      var BASE_TITLE = document.title;

      function updateApprovalBadge(count) {
        if (count > 0) {
          document.title = '(' + count + ') ' + BASE_TITLE;
        } else {
          document.title = BASE_TITLE;
        }
      }

      var _initCount = {{ pending_approvals_count or 0 }};
      if (_initCount > 0) {
        document.title = '(' + _initCount + ') ' + BASE_TITLE;
      }

      document.body.addEventListener('htmx:afterSwap', function () {
        var carrier = document.getElementById('status-bar-approval-count');
        if (carrier) {
          var count = parseInt(carrier.getAttribute('data-count') || '0', 10) || 0;
          updateApprovalBadge(count);
        }
      });

      window.updateApprovalBadge = updateApprovalBadge;
    })();
  </script>

  {% block scripts %}{% endblock %}
</body>
</html>
