<div class="card-label">OPEN POSITIONS</div>

{% if close_error is defined and close_error %}
  <div style="padding:4px 8px; margin-bottom:4px;
              background:rgba(255,68,68,0.08); border-radius:3px;
              color:var(--color-negative); font-size:10px; border:1px solid rgba(255,68,68,0.2);">
    âš  {{ close_error }}
  </div>
{% endif %}

{% if positions %}
  <table class="positions-table">
    <thead>
      <tr>
        <th>SYMBOL</th>
        <th>SIDE</th>
        <th>QTY</th>
        <th>ENTRY</th>
        <th>MARK</th>
        <th>P&amp;L</th>
        <th>STRATEGY</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      {% for pos in positions %}
      <tr id="pos-row-{{ pos.symbol | replace('/', '_') | replace(':', '_') }}">
        <td style="font-weight:600;">{{ pos.symbol }}</td>
        <td class="{{ 'side-long' if pos.side == 'LONG' else 'side-short' }}">
          {{ pos.side }}
        </td>
        <td>{{ pos.qty }}</td>
        <td>${{ pos.entry_price }}</td>
        <td>${{ pos.mark_price }}</td>
        <td class="{{ 'side-long' if pos.pnl_positive else 'side-short' }}">
          {{ pos.unrealized_pnl }}
        </td>
        <td style="color:var(--text-muted);">{{ pos.strategy }}</td>
        <td>
          <button class="btn btn-deny" style="font-size:9px; padding:1px 8px;"
                  onclick="confirmPositionClose('{{ pos.symbol }}', '{{ pos.side }}', '{{ pos.qty }}')"
                  type="button">CLOSE</button>
          <button id="close-submit-{{ pos.symbol | replace('/', '_') | replace(':', '_') }}"
                  hx-post="/actions/positions/close/{{ pos.symbol }}"
                  hx-target="#positions-container"
                  hx-swap="innerHTML"
                  style="display:none;"
                  type="button"></button>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <div class="empty-state" style="padding:8px 0;">
    <div class="empty-message">NO OPEN POSITIONS</div>
    <div class="empty-detail">Strategies are monitoring the market</div>
  </div>
{% endif %}

<script>
  var _pendingCloseSymbol = null;

  function confirmPositionClose(symbol, side, qty) {
    _pendingCloseSymbol = symbol;
    var safeSym = symbol.replace(/\//g, '_').replace(/:/g, '_');
    document.getElementById('close-pos-modal-body').innerHTML =
      'Close <strong>' + side + ' ' + qty + ' ' + symbol + '</strong>?<br><br>' +
      'This will place a <strong>market order</strong> at the current price.';
    document.getElementById('close-position-modal').classList.remove('hidden');
  }

  function cancelPositionClose() {
    document.getElementById('close-position-modal').classList.add('hidden');
    _pendingCloseSymbol = null;
  }

  function submitPositionClose() {
    if (_pendingCloseSymbol) {
      var safeSym = _pendingCloseSymbol.replace(/\//g, '_').replace(/:/g, '_');
      var btn = document.getElementById('close-submit-' + safeSym);
      if (btn) btn.click();
      cancelPositionClose();
    }
  }
</script>
