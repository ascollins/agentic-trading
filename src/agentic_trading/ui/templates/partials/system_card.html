<div class="card-label">SYSTEM STATUS <span class="tooltip-wrap info-icon">&#9432;<span class="tooltip-text">Health of all running agents. Shows total count, individual status, error counts, and last candle feed timestamp.</span></span></div>
{% if system %}
  <div style="display:flex; align-items:center; gap:6px; margin:4px 0;">
    <span class="status-dot {{ 'healthy' if system.all_healthy else 'warning' }}" style="width:6px;height:6px;"></span>
    <span style="font-weight:600; font-size:12px; text-transform:uppercase;">
      {% if system.all_healthy %}ALL HEALTHY{% else %}DEGRADED{% endif %}
    </span>
  </div>

  <div style="display:flex; gap:12px; font-size:10px; color:var(--text-muted); margin:4px 0;">
    <span><strong style="color:var(--text-primary);">{{ system.agents_healthy }}/{{ system.agents_total }}</strong> AGENTS</span>
    <span>CANDLE <strong style="color:var(--text-primary);">{{ system.last_candle_seconds }}s</strong></span>
    {% if system.dlq_count > 0 %}
    <span style="color:var(--color-warning);">⚠ DLQ: <strong>{{ system.dlq_count }}</strong></span>
    {% endif %}
  </div>

  {% if system.agent_details %}
  <div style="margin-top:6px;">
    <button style="font-size:9px; color:var(--text-muted); background:none; border:none; cursor:pointer; padding:0; font-family:'JetBrains Mono',monospace;"
            onclick="toggleAgentDetails(this)" type="button">
      ▶ DETAILS
    </button>
    <div class="agent-detail-panel" style="display:none; margin-top:4px;">
      <table class="positions-table" style="width:100%;">
        <thead>
          <tr>
            <th>AGENT</th>
            <th>TYPE</th>
            <th>STATUS</th>
            <th>ERR</th>
          </tr>
        </thead>
        <tbody>
          {% for agent in system.agent_details %}
          <tr>
            <td style="font-weight:500;">{{ agent.name }}</td>
            <td>{{ agent.type }}</td>
            <td>
              <span class="status-dot {{ 'healthy' if agent.healthy else 'critical' }}" style="width:5px;height:5px;"></span>
              {{ 'OK' if agent.healthy else 'ERR' }}
            </td>
            <td>
              {% if agent.error_count > 0 %}
                <span style="color:var(--color-warning);">{{ agent.error_count }}</span>
              {% else %}
                <span style="color:var(--text-muted);">0</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

{% else %}
  <div class="empty-state" style="padding:8px 0;">
    <div class="empty-message">UNAVAILABLE</div>
    <div class="empty-detail">Agent registry not initialised</div>
  </div>
{% endif %}

<script>
  function toggleAgentDetails(btn) {
    var panel = btn.nextElementSibling;
    if (!panel) return;
    var visible = panel.style.display !== 'none';
    panel.style.display = visible ? 'none' : 'block';
    btn.textContent = visible ? '▶ DETAILS' : '▼ DETAILS';
  }
</script>
