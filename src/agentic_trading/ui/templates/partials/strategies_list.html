{% set stage_order = ['candidate', 'backtest', 'eval_pack', 'paper', 'limited', 'scale'] %}
{% set stage_labels = {
  'candidate': 'CAND',
  'backtest': 'BT',
  'eval_pack': 'EVAL',
  'paper': 'PAPER',
  'limited': 'LIMITED',
  'scale': 'SCALE',
  'live': 'LIVE',
  'configured': 'CFG'
} %}

{% if promotion_result is defined and promotion_result %}
  <div style="margin-bottom:4px; padding:6px 8px; font-size:10px; border-radius:3px;
    {% if promotion_result.approved %}
      background:rgba(0,255,136,0.08); border:1px solid rgba(0,255,136,0.2); color:var(--color-positive);
    {% else %}
      background:rgba(255,187,0,0.08); border:1px solid rgba(255,187,0,0.2); color:var(--color-warning);
    {% endif %}
  ">
    {% if promotion_result.approved %}✓{% else %}✗{% endif %}
    {{ promotion_result.reason }}
  </div>
{% endif %}

{% if strategies %}
<table class="positions-table" style="width:100%;">
  <thead>
    <tr>
      <th>STRATEGY</th>
      <th>STAGE</th>
      <th>GRADE</th>
      <th style="text-align:right;">WIN%</th>
      <th style="text-align:right;">P&amp;L</th>
      <th style="text-align:right;">TRADES</th>
      <th style="text-align:right;">ACTIONS</th>
    </tr>
  </thead>
  <tbody>
    {% for strategy in strategies %}
    {% set current_label = stage_labels.get(strategy.stage, strategy.stage | upper) %}
    <tr>
      <td>
        <span style="font-weight:600; color:var(--text-primary);">
          {{ strategy.strategy_id | replace('_', ' ') | title }}
        </span>
      </td>
      <td>
        <span class="badge" style="font-size:9px; padding:1px 5px; letter-spacing:0.5px;
          {% if strategy.stage in ['scale', 'live'] %}
            background:rgba(0,255,136,0.1); color:var(--color-positive); border:1px solid rgba(0,255,136,0.2);
          {% elif strategy.stage in ['paper', 'limited'] %}
            background:rgba(0,170,255,0.1); color:#00aaff; border:1px solid rgba(0,170,255,0.2);
          {% else %}
            background:rgba(255,255,255,0.05); color:var(--text-muted); border:1px solid rgba(255,255,255,0.08);
          {% endif %}
        ">{{ current_label }}</span>
      </td>
      <td>
        <span style="font-weight:600; font-size:11px;
          {% if strategy.quality_score >= 70 %}color:var(--color-positive);
          {% elif strategy.quality_score >= 50 %}color:var(--color-warning);
          {% else %}color:var(--color-negative);{% endif %}
        ">{{ strategy.quality_grade }} {{ strategy.quality_score }}</span>
      </td>
      <td style="text-align:right; font-family:'JetBrains Mono',monospace;">
        {{ strategy.win_rate }}%
      </td>
      <td style="text-align:right; font-family:'JetBrains Mono',monospace;">
        <span class="{{ 'side-long' if strategy.pnl_positive else 'side-short' }}">
          {{ "+" if strategy.pnl_positive else "" }}${{ "{:,.0f}".format(strategy.pnl_today) }}
        </span>
      </td>
      <td style="text-align:right; font-family:'JetBrains Mono',monospace;">
        {{ strategy.total_trades }}
      </td>
      <td style="text-align:right; white-space:nowrap;">
        {% if strategy.stage in ['paper', 'limited'] and strategy.quality_score >= 60 %}
          <button class="btn btn-primary" style="font-size:9px; padding:1px 8px; line-height:1.4;"
                  onclick="confirmPromotion('{{ strategy.strategy_id }}', '{{ current_label }}', {{ strategy.quality_score }})"
                  type="button">PROMOTE</button>
          <form id="promote-form-{{ strategy.strategy_id }}" style="display:none;">
            <button hx-post="/actions/promote/{{ strategy.strategy_id }}"
                    hx-target="#strategies-list"
                    hx-swap="innerHTML"
                    id="promote-submit-{{ strategy.strategy_id }}"></button>
          </form>
        {% endif %}
        <a href="http://localhost:3001/d/strategy-performance/strategy-performance?orgId=1&var-strategy={{ strategy.strategy_id }}&from=now-7d&to=now"
           target="_blank" style="color:var(--text-muted);font-size:9px;margin-left:4px;text-decoration:none;"
           title="View in Grafana">↗</a>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% else %}
  <div class="empty-state">
    <div class="empty-message">NO STRATEGIES REGISTERED</div>
    <div class="empty-detail">Configure strategies in your TOML config file</div>
  </div>
{% endif %}
