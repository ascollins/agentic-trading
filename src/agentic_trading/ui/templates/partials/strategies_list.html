{% set stage_order = ['candidate', 'backtest', 'eval_pack', 'paper', 'limited', 'scale'] %}
{% set stage_labels = {
  'candidate': 'Candidate',
  'backtest': 'Backtested',
  'eval_pack': 'Evaluation',
  'paper': 'Paper Testing',
  'limited': 'Limited Live',
  'scale': 'Scaling'
} %}

{% if promotion_result is defined and promotion_result %}
  <div class="card" style="margin-bottom: 16px; padding: 12px 16px;
    {% if promotion_result.approved %}
      background: var(--color-positive-bg); border-color: rgba(52,211,153,0.3);
    {% else %}
      background: var(--color-warning-bg); border-color: rgba(251,191,36,0.3);
    {% endif %}
  ">
    <span style="font-size: 0.875rem; font-weight: 500;">
      {% if promotion_result.approved %}
        ✓ Promotion approved: {{ promotion_result.reason }}
      {% else %}
        ✗ Promotion denied: {{ promotion_result.reason }}
      {% endif %}
    </span>
  </div>
{% endif %}

{% for strategy in strategies %}
  {% set current_idx = stage_order.index(strategy.stage) if strategy.stage in stage_order else 0 %}
  {% set current_label = stage_labels.get(strategy.stage, strategy.stage) %}
  <div class="strategy-card">
    <div class="strategy-header">
      <div>
        <div class="strategy-name">{{ strategy.strategy_id | replace('_', ' ') | title }}</div>
        <div style="font-size: 0.8125rem; color: var(--text-muted); margin-top: 2px;">
          Stage: <span style="color: var(--accent-cyan);">{{ current_label }}</span>
        </div>
      </div>
      <div class="tooltip-wrap">
        <div class="strategy-grade {{ 'score-good' if strategy.quality_score >= 70 else ('score-ok' if strategy.quality_score >= 50 else 'score-bad') }}">
          {{ strategy.quality_grade }} {{ strategy.quality_score }}
        </div>
        <div class="tooltip-text">
          <strong>Quality Score: {{ strategy.quality_score }}/100</strong><br><br>
          {% if strategy.quality_breakdown is defined and strategy.quality_breakdown.win_rate_pct > 0 %}
          Win Rate: {{ strategy.quality_breakdown.win_rate_pct }}%
            &nbsp;({{ strategy.quality_breakdown.win_rate_score }}/25 · target &gt;50%)<br>
          Profit Factor: {{ strategy.quality_breakdown.profit_factor_val }}
            &nbsp;({{ strategy.quality_breakdown.profit_factor_score }}/25 · target &gt;1.5)<br>
          Sharpe Ratio: {{ strategy.quality_breakdown.sharpe_val }}
            &nbsp;({{ strategy.quality_breakdown.sharpe_score }}/25 · target &gt;1.0)<br>
          Trade Efficiency: {{ strategy.quality_breakdown.efficiency_pct }}%
            &nbsp;({{ strategy.quality_breakdown.efficiency_score }}/25 · target &gt;60%)<br>
          {% else %}
          Win Rate (up to 25 pts)<br>
          Profit Factor (up to 25 pts)<br>
          Sharpe Ratio (up to 25 pts)<br>
          Trade Efficiency (up to 25 pts)<br>
          {% endif %}
          <br>
          <em>≥70 = Good · ≥50 = OK · &lt;50 = Needs improvement</em>
        </div>
      </div>
    </div>

    <!-- Stage Progress Ribbon -->
    <div class="stage-ribbon">
      {% for stage in stage_order %}
        {% set idx = loop.index0 %}
        <div class="stage-dot {{ 'completed' if idx < current_idx else ('current' if idx == current_idx else '') }}"></div>
        {% if not loop.last %}
          <div class="stage-connector {{ 'completed' if idx < current_idx else '' }}"></div>
        {% endif %}
      {% endfor %}
    </div>
    <div class="stage-labels">
      {% for stage in stage_order %}
        {% set idx = loop.index0 %}
        <span class="stage-label {{ 'current' if idx == current_idx else '' }}"
              title="{{ stage_labels.get(stage, stage) }}">
          {{ stage_labels.get(stage, stage)[:3] | upper if idx != current_idx else stage_labels.get(stage, stage) }}
        </span>
      {% endfor %}
    </div>

    <!-- Stats row -->
    <div class="strategy-stats" style="margin-top: 16px;">
      <div>
        <span class="{{ 'side-long' if strategy.pnl_positive else 'side-short' }}" style="font-family: 'SF Mono', monospace; font-weight: 600;">
          {{ "+" if strategy.pnl_positive else "" }}${{ "{:,.0f}".format(strategy.pnl_today) }}
        </span>
        today
      </div>
      <div>
        <span class="stat-value">{{ strategy.total_trades }}</span> trades
      </div>
      <div>
        Win Rate <span class="stat-value">{{ strategy.win_rate }}%</span>
      </div>
      {% if strategy.stage in ['paper', 'limited'] %}
      <div>
        {% if strategy.quality_score >= 60 %}
          <button class="btn btn-primary" style="font-size: 0.75rem; padding: 2px 12px;"
                  onclick="confirmPromotion('{{ strategy.strategy_id }}', '{{ current_label }}', {{ strategy.quality_score }})"
                  type="button">
            Promote →
          </button>
          <form id="promote-form-{{ strategy.strategy_id }}" style="display:none;">
            <button hx-post="/actions/promote/{{ strategy.strategy_id }}"
                    hx-target="#strategies-list"
                    hx-swap="innerHTML"
                    id="promote-submit-{{ strategy.strategy_id }}">
            </button>
          </form>
        {% else %}
          <span class="tooltip-wrap">
            <button class="btn btn-ghost" style="font-size: 0.75rem; padding: 2px 12px; opacity: 0.5; cursor: not-allowed;" disabled>
              Promote →
            </button>
            <span class="tooltip-text">Score too low to promote ({{ strategy.quality_score }}/100). Minimum required: 60.</span>
          </span>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Grafana deep link -->
    <div style="margin-top: 10px; display: flex; justify-content: flex-end;">
      <a href="http://localhost:3001/d/strategy-performance/strategy-performance?orgId=1&var-strategy={{ strategy.strategy_id }}&from=now-7d&to=now"
         target="_blank" class="grafana-link" style="font-size: 0.75rem;">
        ↗ View charts in Grafana
      </a>
    </div>
  </div>
{% endfor %}

{% if not strategies %}
  <div class="empty-state">
    <div class="empty-message">No strategies registered</div>
    <div class="empty-detail">Configure strategies in your TOML config file</div>
  </div>
{% endif %}

<!-- Promotion confirmation modal -->
<div class="modal-overlay hidden" id="promote-modal">
  <div class="modal-box">
    <div class="modal-title">Promote Strategy?</div>
    <div class="modal-body" id="promote-modal-body">
      This will request promotion for this strategy to the next stage.
    </div>
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="closePromoteModal()">Cancel</button>
      <button class="btn btn-primary" id="promote-modal-confirm" onclick="submitPromotion()">Confirm Promotion</button>
    </div>
  </div>
</div>

<script>
  let _pendingStrategyId = null;

  function confirmPromotion(strategyId, currentStage, score) {
    _pendingStrategyId = strategyId;
    document.getElementById('promote-modal-body').innerHTML =
      '<strong>' + strategyId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()) + '</strong> is currently in <em>' + currentStage + '</em> with a quality score of <strong>' + score + '/100</strong>.<br><br>Request promotion to the next stage?';
    document.getElementById('promote-modal').classList.remove('hidden');
  }

  function closePromoteModal() {
    document.getElementById('promote-modal').classList.add('hidden');
    _pendingStrategyId = null;
  }

  function submitPromotion() {
    if (_pendingStrategyId) {
      document.getElementById('promote-submit-' + _pendingStrategyId).click();
      closePromoteModal();
    }
  }

  // Close on overlay click
  document.getElementById('promote-modal').addEventListener('click', function(e) {
    if (e.target === this) closePromoteModal();
  });
</script>
